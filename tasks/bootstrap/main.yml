---

- tags: [ bootstrap ]
  become: True
  block:

  - debug:
      msg: |
        Hostname: {{ ansible_hostname }}    ansible version: {{ ansible_version }}
        Fqdn: {{ ansible_fqdn }}
        Inventory Hostname {{ inventory_hostname }}

        Distribution is {{ ansible_distribution }}-{{ ansible_distribution_major_version }}
        Specific version is {{ ansible_distribution_version }}
        OS family is {{ ansible_os_family }}
        Release: {{ ansible_distribution_release }}
        Ansible python version: {{ ansible_python_version }}
        default ipv4: {{ ansible_default_ipv4.address | default('<undefined>') }}

  - name: Fail if Ansible is old
    fail: msg="We need updates in Ansible 2.5.0. Please update your kit. 'pip install -U Ansible'"
    when: ansible_version is version('2.5.0', 'lt')

  - name: create the the creds store
    delegate_to: 127.0.0.1
    become: no
    file:
      path: ~/.local/share/ansible/store
      state: directory

  - name: "distro specific bootstrapping {{ ansible_distribution }}-{{ ansible_distribution_version}}"
    include_tasks: "{{ include_tasks_bootstrap }}"
    with_first_found:
      - "{{ ansible_distribution }}-{{ ansible_distribution_version}}.yml"
      - "{{ ansible_distribution }}-{{ ansible_distribution_major_version}}.yml"
      - "{{ ansible_distribution }}.yml"
      - "{{ ansible_os_family }}.yml"
      - "{{ ansible_system }}.yml"
    loop_control:
      loop_var: include_tasks_bootstrap

  - name: flag to indicate some role ran bootstrapping
    set_fact:
      bootstrap_done: true

  - file:
      name: "/var/cache/ansible/bootstrap"
      state: directory

  - include_tasks: distro-debug-packages.yml
    when: lookup('env', '_DTOOLS')
